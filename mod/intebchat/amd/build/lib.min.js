/**
 * Main JavaScript for INTEB Chat module with Conversations Management
 *
 * @module     mod_intebchat/lib
 * @copyright  2025 Alonso Arias <soporte@ingeweb.co>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_intebchat/lib",["jquery","core/ajax","core/str","core/notification","core/modal_factory","core/modal_events","core/templates"],(function($,Ajax,Str,Notification,ModalFactory,ModalEvents,Templates){var questionString="Ask a question...",errorString="An error occurred! Please try again later.",currentConversationId=null,tokenInfo={enabled:!1,limit:0,used:0,exceeded:!1,resetTime:0},strings={},audioConfig={enabled:!1,mode:"text"},sendAudioMessage=function(instanceId,api_type){if($("#intebchat-recorded-audio").val()){var doSend=function(){addToChatLog("user transcribing",'<i class="fa fa-microphone"></i> '+(strings.transcribing||"Transcribing..."),instanceId),createCompletion("",instanceId,api_type)};currentConversationId?doSend():Ajax.call([{methodname:"mod_intebchat_create_conversation",args:{instanceid:instanceId},done:function(response){currentConversationId=response.conversationid,$("#conversation-title").text(response.title);var conversationHtml=createConversationListItem(response);$(".intebchat-no-conversations").length>0?$(".intebchat-conversations-list").html(conversationHtml):$(".intebchat-conversations-list").prepend(conversationHtml),$(".intebchat-conversation-item").removeClass("active"),$('.intebchat-conversation-item[data-conversation-id="'+currentConversationId+'"]').addClass("active"),doSend()}}])}},loadStrings=function(){return Str.get_strings([{key:"askaquestion",component:"mod_intebchat"},{key:"erroroccurred",component:"mod_intebchat"},{key:"newconversation",component:"mod_intebchat"},{key:"confirmclear",component:"mod_intebchat"},{key:"conversationcleared",component:"mod_intebchat"},{key:"loadingconversation",component:"mod_intebchat"},{key:"edittitle",component:"mod_intebchat"},{key:"clearconversation",component:"mod_intebchat"},{key:"cancel",component:"core"},{key:"save",component:"core"},{key:"delete",component:"core"},{key:"conversationtitle",component:"mod_intebchat"},{key:"confirmclearmessage",component:"mod_intebchat"}]).then((function(results){strings.askaquestion=results[0],strings.erroroccurred=results[1],strings.newconversation=results[2],strings.confirmclear=results[3],strings.conversationcleared=results[4],strings.loadingconversation=results[5],strings.edittitle=results[6],strings.clearconversation=results[7],strings.cancel=results[8],strings.save=results[9],strings.delete=results[10],strings.conversationtitle=results[11]||"Conversation Title",strings.confirmclearmessage=results[12]||"Are you sure you want to clear this conversation? This action cannot be undone.",questionString=strings.askaquestion,errorString=strings.erroroccurred}))},showEditTitleModal=function(conversationId){var currentTitle=$("#conversation-title").text();ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings.edittitle,body:'<div class="form-group"><label for="conversation-title-input">'+strings.conversationtitle+'</label><input type="text" class="form-control" id="conversation-title-input" value="'+currentTitle.replace(/"/g,"&quot;")+'"></div>'}).then((function(modal){modal.setSaveButtonText(strings.save),modal.getRoot().on(ModalEvents.save,(function(e){var newTitle=$("#conversation-title-input").val().trim();newTitle&&newTitle!==currentTitle&&updateConversationTitle(conversationId,newTitle)})),modal.getRoot().on(ModalEvents.shown,(function(){$("#conversation-title-input").focus().select()})),modal.getRoot().on("keypress","#conversation-title-input",(function(e){13===e.which&&modal.save()})),modal.show()}))},showClearConversationModal=function(conversationId,instanceId){ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings.clearconversation,body:"<p>"+strings.confirmclearmessage+"</p>"}).then((function(modal){modal.setSaveButtonText(strings.delete),modal.getRoot().find(".btn-primary").removeClass("btn-primary").addClass("btn-danger"),modal.getRoot().on(ModalEvents.save,(function(e){clearConversation(conversationId,instanceId)})),modal.show()}))},initializeConversations=function(instanceId){var firstConversation=$(".intebchat-conversation-item").first();firstConversation.length>0&&firstConversation.click()},createNewConversation=function(instanceId){Ajax.call([{methodname:"mod_intebchat_create_conversation",args:{instanceid:instanceId},done:function(response){currentConversationId=response.conversationid,$("#intebchat_log").empty(),$("#conversation-title").text(response.title);var conversationHtml=createConversationListItem(response);$(".intebchat-no-conversations").length>0?$(".intebchat-conversations-list").html(conversationHtml):$(".intebchat-conversations-list").prepend(conversationHtml),$(".intebchat-conversation-item").removeClass("active"),$('.intebchat-conversation-item[data-conversation-id="'+currentConversationId+'"]').addClass("active"),$("#openai_input").length&&$("#openai_input").focus()},fail:function(error){Notification.addNotification({message:error.message||strings.erroroccurred,type:"error"})}}])},loadConversation=function(conversationId,instanceId){$("#intebchat_log").html('<div class="loading-conversation"><i class="fa fa-spinner fa-spin"></i> '+strings.loadingconversation+"</div>"),Ajax.call([{methodname:"mod_intebchat_load_conversation",args:{conversationid:conversationId,instanceid:instanceId},done:function(response){currentConversationId=conversationId,$("#conversation-title").text(response.title),$("#intebchat_log").empty(),response.messages.forEach((function(msg){addToChatLog("user"===msg.role?"user":"bot",msg.message,instanceId,!1)})),$(".intebchat-conversation-item").removeClass("active"),$('.intebchat-conversation-item[data-conversation-id="'+conversationId+'"]').addClass("active"),$("#conversations-sidebar").removeClass("mobile-open");var messageContainer=$("#intebchat_log");messageContainer.animate({scrollTop:messageContainer[0].scrollHeight},300)},fail:function(error){$("#intebchat_log").empty(),Notification.addNotification({message:error.message||strings.erroroccurred,type:"error"})}}])},clearConversation=function(conversationId,instanceId){Ajax.call([{methodname:"mod_intebchat_clear_conversation",args:{conversationid:conversationId},done:function(response){response.deleted?($('.intebchat-conversation-item[data-conversation-id="'+conversationId+'"]').fadeOut(300,(function(){if($(this).remove(),0===$(".intebchat-conversation-item").length)createNewConversation(instanceId);else{var firstConv=$(".intebchat-conversation-item").first();firstConv.length>0&&firstConv.click()}})),Notification.addNotification({message:strings.conversationcleared,type:"success"})):($("#intebchat_log").empty(),$('.intebchat-conversation-item[data-conversation-id="'+conversationId+'"]').find(".intebchat-conversation-preview").text(""),Notification.addNotification({message:strings.conversationcleared,type:"success"}),refreshConversationInSidebar(conversationId))},fail:function(error){Notification.addNotification({message:error.message||strings.erroroccurred,type:"error"})}}])},updateConversationTitle=function(conversationId,newTitle){Ajax.call([{methodname:"mod_intebchat_update_conversation_title",args:{conversationid:conversationId,title:newTitle},done:function(response){if(response&&response.success){$("#conversation-title").text(newTitle);var $item=$('.intebchat-conversation-item[data-conversation-id="'+conversationId+'"]');$item.find(".title-text").text(newTitle),$item.attr("data-title",newTitle),Notification.addNotification({message:strings.edittitle,type:"success"})}else Notification.addNotification({message:strings.erroroccurred,type:"error"})},fail:function(error){Notification.addNotification({message:error.message||strings.erroroccurred,type:"error"})}}])},refreshConversationInSidebar=function(conversationId){var $item=$('.intebchat-conversation-item[data-conversation-id="'+conversationId+'"]');if($item.length){var now=new Date;$item.find(".intebchat-conversation-date").text(now.toLocaleDateString([],{day:"2-digit",month:"2-digit"})),$item.is(":first-child")||$item.fadeOut(200,(function(){$(this).prependTo(".intebchat-conversations-list").fadeIn(200)}))}},filterConversations=function(searchTerm){searchTerm=searchTerm.toLowerCase(),$(".intebchat-conversation-item").each((function(){var title=$(this).find(".title-text").text().toLowerCase(),preview=$(this).find(".intebchat-conversation-preview").text().toLowerCase();title.includes(searchTerm)||preview.includes(searchTerm)?$(this).show():$(this).hide()}))},createConversationListItem=function(conversation){var dateStr=new Date(1e3*conversation.lastmessage).toLocaleDateString([],{day:"2-digit",month:"2-digit"});return'<div class="intebchat-conversation-item" data-conversation-id="'+conversation.conversationid+'" data-title="'+conversation.title+'"><div class="intebchat-conversation-title"><span class="title-text">'+conversation.title+'</span><span class="intebchat-conversation-date">'+dateStr+'</span></div><div class="intebchat-conversation-preview">'+conversation.preview+"</div></div>"},sendMessage=function(message,instanceId,api_type){currentConversationId?(addToChatLog("user",message,instanceId),createCompletion(message,instanceId,api_type)):Ajax.call([{methodname:"mod_intebchat_create_conversation",args:{instanceid:instanceId},done:function(response){currentConversationId=response.conversationid,$("#conversation-title").text(response.title);var conversationHtml=createConversationListItem(response);$(".intebchat-no-conversations").length>0?$(".intebchat-conversations-list").html(conversationHtml):$(".intebchat-conversations-list").prepend(conversationHtml),$(".intebchat-conversation-item").removeClass("active"),$('.intebchat-conversation-item[data-conversation-id="'+currentConversationId+'"]').addClass("active"),addToChatLog("user",message,instanceId),createCompletion(message,instanceId,api_type)},fail:function(error){Notification.addNotification({message:error.message||errorString,type:"error"})}}])},updateTokenUI=function(){if(tokenInfo.enabled){var $container=$(".mod_intebchat"),$input=$container.find("#openai_input"),$submitBtn=$container.find("#go"),$progressBar=$container.find(".progress-bar");if(tokenInfo.exceeded?($input.prop("disabled",!0),$submitBtn.prop("disabled",!0)):($input.prop("disabled",!1),$submitBtn.prop("disabled",!1)),$progressBar.length){var percentage=tokenInfo.used/tokenInfo.limit*100;$progressBar.css("width",percentage+"%"),$progressBar.removeClass("warning danger"),percentage>90?$progressBar.addClass("danger"):percentage>75&&$progressBar.addClass("warning")}}},checkTokenReset=function(){var now=Date.now()/1e3;tokenInfo.exceeded&&now>tokenInfo.resetTime&&window.location.reload()},addToChatLog=function(type,message,instanceId){let animate=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];var messageContainer=$('.mod_intebchat[data-instance-id="'+instanceId+'"] #intebchat_log');"user transcribing"!==type&&messageContainer.find(".openai_message.transcribing").remove();var messageElem=$("<div></div>").addClass("openai_message").addClass(type.replace(" ","-")),messageText=$("<span></span>").html(message);messageElem.append(messageText);var timestamp=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),timestampElem=$("<span></span>").addClass("message-timestamp").text(timestamp);messageElem.append(timestampElem),animate?(messageElem.hide(),messageContainer.append(messageElem),messageElem.fadeIn(300)):messageContainer.append(messageElem),messageContainer.animate({scrollTop:messageContainer[0].scrollHeight},300)},createCompletion=function(message,instanceId,api_type){var history=buildTranscript(instanceId);$('.mod_intebchat[data-instance-id="'+instanceId+'"] #control_bar').addClass("disabled"),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').removeClass("error"),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').attr("placeholder",questionString),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').blur(),$('.mod_intebchat[data-instance-id="'+instanceId+'"] .openai_message.transcribing').length||addToChatLog("bot loading","...",instanceId);var audio=$("#intebchat-recorded-audio").val();$.ajax({url:M.cfg.wwwroot+"/mod/intebchat/api/completion.php",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({message:message,history:history,instanceId:instanceId,conversationId:currentConversationId||null,threadId:null,audio:audio||null}),success:function(data){$("#intebchat-recorded-audio").val("");var messageContainer=$('.mod_intebchat[data-instance-id="'+instanceId+'"] #intebchat_log');messageContainer.find(".openai_message.bot-loading, .openai_message.user-transcribing").remove(),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #control_bar').removeClass("disabled"),data.message?(audio&&data.transcription&&(messageContainer.find(".openai_message.user-transcribing").remove(),addToChatLog("user",data.transcription,instanceId)),addToChatLog("bot",data.message,instanceId),data.conversationId&&!currentConversationId&&(currentConversationId=data.conversationId),currentConversationId&&updateConversationPreview(currentConversationId,data.transcription||message),data.tokenInfo&&tokenInfo.enabled&&(tokenInfo.used+=data.tokenInfo.total||0,updateTokenUI(),tokenInfo.used>=tokenInfo.limit&&(tokenInfo.exceeded=!0,updateTokenUI(),Notification.addNotification({message:strings.tokenlimitexceeded||"Token limit exceeded",type:"error"})))):data.error&&("token_limit_exceeded"===data.error.type?(tokenInfo.exceeded=!0,updateTokenUI(),Notification.addNotification({message:data.error.message,type:"error"})):addToChatLog("bot error",data.error.message,instanceId)),$("#openai_input").length&&$("#openai_input").focus()},error:function(xhr,status,error){$('.mod_intebchat[data-instance-id="'+instanceId+'"] #intebchat_log').find(".openai_message.bot-loading, .openai_message.user-transcribing").remove(),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #control_bar').removeClass("disabled");var errorMsg=errorString;try{var response=JSON.parse(xhr.responseText);response.error&&(errorMsg=response.error)}catch(e){}addToChatLog("bot error",errorMsg,instanceId),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').addClass("error"),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').attr("placeholder",errorString)}})},updateConversationPreview=function(conversationId,lastMessage){if(lastMessage){var $item=$('.intebchat-conversation-item[data-conversation-id="'+conversationId+'"]');if($item.length){$item.find(".intebchat-conversation-preview").text(lastMessage);var now=new Date;$item.find(".intebchat-conversation-date").text(now.toLocaleDateString([],{day:"2-digit",month:"2-digit"})),$item.is(":first-child")||$item.fadeOut(200,(function(){$(this).prependTo(".intebchat-conversations-list").fadeIn(200)}))}}},buildTranscript=function(instanceId){var transcript=[];return $('.mod_intebchat[data-instance-id="'+instanceId+'"] .openai_message').each((function(index,element){if(index!==$('.mod_intebchat[data-instance-id="'+instanceId+'"] .openai_message').length-1){var user=userName;$(element).hasClass("bot")&&(user=assistantName);var messageText=$(element).clone();messageText.find(".message-timestamp").remove(),messageText.find("audio").remove(),messageText.find(".transcription").remove(),transcript.push({user:user,message:messageText.text().trim()})}})),transcript};return{init:function(data){var instanceId=data.instanceId,api_type=data.api_type;data.persistConvo;tokenInfo.enabled=data.tokenLimitEnabled||!1,tokenInfo.limit=data.tokenLimit||0,tokenInfo.used=data.tokensUsed||0,tokenInfo.exceeded=data.tokenLimitExceeded||!1,tokenInfo.resetTime=data.resetTime||0,audioConfig.enabled=data.audioEnabled||!1,audioConfig.mode=data.audioMode||"text",updateTokenUI(),loadStrings().then((function(){initializeConversations(instanceId),$("#openai_input").length&&$("#openai_input").attr("placeholder",strings.askaquestion)})),"text"!==audioConfig.mode&&"both"!==audioConfig.mode||($(document).on("keyup",'.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input',(function(e){13!==e.which||e.shiftKey||""===e.target.value||(e.preventDefault(),tokenInfo.exceeded||(sendMessage(e.target.value,instanceId,api_type),e.target.value=""))})),$(document).on("click",'.mod_intebchat[data-instance-id="'+instanceId+'"] #go',(function(e){var input=$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input');""===input.val()||tokenInfo.exceeded||(sendMessage(input.val(),instanceId,api_type),input.val(""))}))),audioConfig.enabled&&("audio"===audioConfig.mode?$(document).on("audio-ready","#intebchat-icon-stop",(function(){$("#intebchat-recorded-audio").val()&&!tokenInfo.exceeded&&sendAudioMessage(instanceId,api_type)})):"both"===audioConfig.mode&&$(document).on("audio-ready","#intebchat-icon-stop",(function(){$("#intebchat-icon-stop").data("ready",!0)}))),$(document).on("click","#new-conversation-btn",(function(e){createNewConversation(instanceId)})),$(document).on("click","#clear-conversation-btn",(function(e){currentConversationId&&showClearConversationModal(currentConversationId,instanceId)})),$(document).on("click","#edit-title-btn",(function(e){currentConversationId&&showEditTitleModal(currentConversationId)})),$(document).on("click",".intebchat-conversation-item",(function(e){var conversationId=$(this).data("conversation-id");loadConversation(conversationId,instanceId)})),$(document).on("input","#conversation-search",(function(e){filterConversations(e.target.value)})),$(document).on("click","#mobile-menu-toggle",(function(e){$("#conversations-sidebar").toggleClass("mobile-open")})),$("#openai_input").length&&$(document).on("input",'.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input',(function(e){this.style.height="auto",this.style.height=Math.min(this.scrollHeight,120)+"px"})),tokenInfo.enabled&&setInterval(checkTokenReset,6e4),0===$(".intebchat-conversation-item").length&&createNewConversation(instanceId)}}}));

//# sourceMappingURL=lib.min.js.map