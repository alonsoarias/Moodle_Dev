/**
 * Manage tri-state category checkboxes on the download center page.
 *
 * @module     local_downloadcenter/category_tree
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_downloadcenter/category_tree",["jquery","core_form/changechecker","core/ajax","core/notification"],(function($,changechecker,Ajax,Notification){function updateCategoryState($checkbox){var $container=$checkbox.closest(".downloadcenter-category"),$courseboxes=$container.find("> .collapse > .card-body .course-checkbox"),$subcatboxes=$container.find("> .collapse > .card-body > .downloadcenter-category").find("> .card-header input.downloadcenter-category-checkbox"),total=$courseboxes.length+$subcatboxes.length,checked=$courseboxes.filter(":checked").length+$subcatboxes.filter(":checked").length,indeterminateCourses=$courseboxes.filter((function(){return this.indeterminate||"1"===$(this).data("indeterminate")})).length,indeterminateChildren=$subcatboxes.filter((function(){return this.indeterminate})).length;0===total?($checkbox.prop("checked",!1),$checkbox.prop("indeterminate",!1)):checked===total&&0===indeterminateCourses&&0===indeterminateChildren?($checkbox.prop("checked",!0),$checkbox.prop("indeterminate",!1)):checked>0||indeterminateCourses>0||indeterminateChildren>0?($checkbox.prop("checked",!0),$checkbox.prop("indeterminate",!0)):($checkbox.prop("checked",!1),$checkbox.prop("indeterminate",!1))}return{init:function(){$(".downloadcenter-category").each((function(){var $catbox=$(this).find("> .card-header input.downloadcenter-category-checkbox");"1"!==$catbox.data("indeterminate")&&1!==$catbox.data("indeterminate")||$catbox.prop("indeterminate",!0),$catbox.on("change",(function(e){e.stopPropagation();var checked=$catbox.is(":checked");$catbox.prop("indeterminate",!1),function($checkbox,checked){$checkbox.closest(".downloadcenter-category").find(".course-checkbox, .downloadcenter-category-checkbox").not($checkbox).each((function(){var $this=$(this);($this.is(":checked")!==checked||this.indeterminate)&&($this.prop("checked",checked),$this.prop("indeterminate",!1),$this.removeAttr("data-indeterminate"),$this.hasClass("course-checkbox")&&$this.trigger("change.autosave"))}))}($catbox,checked);for(var $current=$catbox.closest(".downloadcenter-category").parents(".downloadcenter-category").first();$current.length;){updateCategoryState($current.find("> .card-header input.downloadcenter-category-checkbox")),$current=$current.parents(".downloadcenter-category").first()}var courseids=$catbox.data("courseids");courseids&&function(categoryid,courseids,checked){return $.post(M.cfg.wwwroot+"/local/downloadcenter/index.php",{action:"togglecategory",categoryid:categoryid,courseids:courseids,checked:checked?1:0,sesskey:M.cfg.sesskey})}($catbox.data("categoryid"),courseids,checked).fail((function(){Notification.exception(new Error("Failed to save category selection")),$catbox.prop("checked",!checked)}))}))})),$(".course-checkbox").each((function(){var $checkbox=$(this);"1"!==$checkbox.data("indeterminate")&&1!==$checkbox.data("indeterminate")||$checkbox.prop("indeterminate",!0),$checkbox.on("change.autosave",(function(e){e.stopPropagation();var courseid=$checkbox.data("courseid"),checked=$checkbox.is(":checked");$checkbox.prop("indeterminate",!1),$checkbox.removeAttr("data-indeterminate"),function(courseid,checked){return $.post(M.cfg.wwwroot+"/local/downloadcenter/index.php",{action:"togglecourse",courseid:courseid,checked:checked?1:0,sesskey:M.cfg.sesskey})}(courseid,checked).done((function(response){if("ok"===response.status){!function($checkbox,checked,partial){var $label=$checkbox.siblings("label");$label.find(".badge").remove(),checked&&!partial?$label.append(' <span class="badge badge-success">'+M.str.local_downloadcenter.selected+"</span>"):partial&&$label.append(' <span class="badge badge-info">'+M.str.local_downloadcenter.selected+" (partial)</span>")}($checkbox,checked,!1);for(var $current=$checkbox.closest(".downloadcenter-category");$current.length;){updateCategoryState($current.find("> .card-header input.downloadcenter-category-checkbox")),$current=$current.parents(".downloadcenter-category").first()}}})).fail((function(){Notification.exception(new Error("Failed to save course selection")),$checkbox.prop("checked",!checked)}))})),$checkbox.on("change",(function(e){e.namespace&&"autosave"===e.namespace||$checkbox.trigger("change.autosave")}))})),$(".downloadcenter-category").each((function(){updateCategoryState($(this).find("> .card-header input.downloadcenter-category-checkbox"))})),$(".downloadcenter-course-form").each((function(){var form=this;void 0!==changechecker&&changechecker.resetFormDirtyState&&($(form).on("change",'input[type="checkbox"]',(function(){setTimeout((function(){changechecker.resetFormDirtyState(form)}),100)})),changechecker.resetFormDirtyState(form))})),$(".downloadcenter-category .collapse").on("shown.bs.collapse hidden.bs.collapse",(function(){updateCategoryState($(this).closest(".downloadcenter-category").find("> .card-header input.downloadcenter-category-checkbox"))}))}}}));

//# sourceMappingURL=category_tree.min.js.map