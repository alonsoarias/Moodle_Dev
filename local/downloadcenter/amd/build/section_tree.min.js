/**
 * Manage section and item checkboxes with tri-state behaviour on the course page.
 *
 * @module     local_downloadcenter/section_tree
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_downloadcenter/section_tree",["jquery","core_form/changechecker","core/notification"],(function($,changechecker,Notification){function updateSectionState(section){var $items=$('input.item-checkbox[data-section="'+section+'"]'),$sectionbox=$('input.section-checkbox[data-section="'+section+'"]');if(0===$items.length)return $sectionbox.prop("checked",!1),void $sectionbox.prop("indeterminate",!1);var checked=$items.filter(":checked").length,total=$items.length;0===checked?($sectionbox.prop("checked",!1),$sectionbox.prop("indeterminate",!1)):checked===total?($sectionbox.prop("checked",!0),$sectionbox.prop("indeterminate",!1)):($sectionbox.prop("checked",!0),$sectionbox.prop("indeterminate",!0))}function updateSelectionSummary(){var totalItems=$("input.item-checkbox").length,checkedItems=$("input.item-checkbox:checked").length,$summary=$("#selection-summary");0===$summary.length&&($summary=$('<div id="selection-summary" class="alert alert-success mb-3"></div>'),$(".downloadcenter-toolbar").after($summary)),checkedItems>0?($summary.text(checkedItems+" of "+totalItems+" items selected"),$summary.show()):$summary.hide()}function saveFormData($form){var data=$form.serializeArray();data.push({name:"action",value:"savecourse"});var courseid=$form.find('input[name="courseid"]').val();courseid||(courseid=new URLSearchParams(window.location.search).get("courseid"));return courseid&&data.push({name:"courseid",value:courseid}),$.post(M.cfg.wwwroot+"/local/downloadcenter/index.php",$.param(data)).done((function(response){if("ok"===response.status){changechecker&&changechecker.resetFormDirtyState&&changechecker.resetFormDirtyState($form[0]),updateSelectionSummary(),function(message){var $feedback=$("#downloadcenter-feedback");0===$feedback.length&&($feedback=$('<div id="downloadcenter-feedback" class="alert alert-success" style="position: fixed; top: 60px; right: 20px; z-index: 1050; display: none;"></div>'),$("body").append($feedback));$feedback.text(message).fadeIn(200),setTimeout((function(){$feedback.fadeOut(200)}),2e3)}("Selection saved");var $saveBtn=$form.find('input[name="submitbutton"]');if($saveBtn.length>0){var checkedCount=$("input.item-checkbox:checked").length;checkedCount>0?$saveBtn.val(M.str.local_downloadcenter.saveselection+" ("+checkedCount+" items)"):$saveBtn.val(M.str.local_downloadcenter.saveselection)}}})).fail((function(){Notification.exception(new Error("Failed to save selection"))}))}return{init:function(){var $form=$("form").first();if(0!==$form.length&&$form.find("input.section-checkbox").length){var func,wait,timeout,debouncedSave=(func=function(){saveFormData($form)},wait=800,function(){var context=this,args=arguments;clearTimeout(timeout),timeout=setTimeout((function(){func.apply(context,args)}),wait)});$("input.section-checkbox").each((function(){var $sectionbox=$(this),section=$sectionbox.data("section");"1"!==$sectionbox.data("indeterminate")&&1!==$sectionbox.data("indeterminate")||$sectionbox.prop("indeterminate",!0),$sectionbox.on("change",(function(e){e.stopPropagation();var checked=$sectionbox.is(":checked");$sectionbox.prop("indeterminate",!1),$('input.item-checkbox[data-section="'+section+'"]').each((function(){$(this).prop("checked",checked)})),updateSelectionSummary(),debouncedSave()}))})),$("input.item-checkbox").each((function(){var $itembox=$(this);$itembox.on("change",(function(e){e.stopPropagation(),updateSectionState($itembox.data("section")),updateSelectionSummary(),debouncedSave()}))})),$("input.section-checkbox").each((function(){updateSectionState($(this).data("section"))})),updateSelectionSummary(),changechecker&&changechecker.resetFormDirtyState&&(changechecker.resetFormDirtyState($form[0]),$form.on("change",'input[type="checkbox"]',(function(){setTimeout((function(){changechecker.resetFormDirtyState($form[0])}),100)}))),$form.on("submit",(function(e){setTimeout((function(){changechecker&&changechecker.resetFormDirtyState&&changechecker.resetFormDirtyState($form[0])}),100)}));var $statusIndicator=$('<div class="downloadcenter-status text-muted small mt-2"><i class="fa fa-check-circle text-success mr-1"></i>Auto-save enabled - changes are saved automatically</div>');$(".downloadcenter-toolbar").after($statusIndicator),$form.on("ajaxStart",(function(){$statusIndicator.html('<i class="fa fa-spinner fa-spin mr-1"></i>Saving changes...')})),$form.on("ajaxComplete",(function(){$statusIndicator.html('<i class="fa fa-check-circle text-success mr-1"></i>Auto-save enabled - changes are saved automatically')})),M.str.local_downloadcenter||(M.str.local_downloadcenter={saveselection:"Save selection"})}}}}));

//# sourceMappingURL=section_tree.min.js.map