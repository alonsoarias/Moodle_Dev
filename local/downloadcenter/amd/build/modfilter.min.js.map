{"version":3,"file":"modfilter.min.js","sources":["../src/modfilter.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Module filter for download center\r\n *\r\n * @module     local_downloadcenter/modfilter\r\n * @copyright  2025 Original: Academic Moodle Cooperation\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(['jquery', 'core/str', 'core/url'], function($, Str, Url) {\r\n\r\n    const ModFilter = function(modnames) {\r\n        const instance = this;\r\n        this.modnames = modnames;\r\n        this.strings = {};\r\n        this.formid = null;\r\n        this.currentlyshown = false;\r\n        this.modlist = null;\r\n\r\n        // Load strings.\r\n        Str.get_strings([\r\n            {key: 'all', component: 'moodle'},\r\n            {key: 'none', component: 'moodle'},\r\n            {key: 'select', component: 'moodle'},\r\n            {key: 'showtypes', component: 'backup'},\r\n            {key: 'hidetypes', component: 'backup'}\r\n        ]).done(function(strs) {\r\n            instance.strings.all = strs[0];\r\n            instance.strings.none = strs[1];\r\n            instance.strings.select = strs[2];\r\n            instance.strings.showtypes = strs[3];\r\n            instance.strings.hidetypes = strs[4];\r\n\r\n            instance.init();\r\n        });\r\n    };\r\n\r\n    ModFilter.prototype.init = function() {\r\n        const instance = this;\r\n        const firstsection = $('div[role=\"main\"] > form .card.block').first();\r\n        \r\n        if (firstsection.length === 0) {\r\n            return;\r\n        }\r\n        \r\n        instance.formid = firstsection.closest('form').prop('id');\r\n\r\n        // Add global select all/none options.\r\n        const showTypeOptionsLink = '<span class=\"font-weight-bold ml-3 text-nowrap\">' +\r\n            '(<a id=\"downloadcenter-bytype\" href=\"#\">' + instance.strings.showtypes + '</a>)</span>';\r\n        \r\n        let html = instance.htmlGenerator('included', instance.strings.select);\r\n        let links = $(document.createElement('div'));\r\n        links.addClass('grouped_settings section_level block card');\r\n        links.html(html);\r\n        links.find('.downloadcenter_selector .col-md-9').append(showTypeOptionsLink);\r\n        links.insertBefore(firstsection);\r\n\r\n        // For each module type, add hidden select all/none options.\r\n        instance.modlist = $(document.createElement('div'));\r\n        instance.modlist.prop('id', 'mod_select_links');\r\n        instance.modlist.prop('class', 'm-l-2');\r\n        instance.modlist.appendTo(links);\r\n        instance.modlist.hide();\r\n\r\n        for (let mod in instance.modnames) {\r\n            if (!instance.modnames.hasOwnProperty(mod)) {\r\n                continue;\r\n            }\r\n\r\n            const img = '<img src=\"' + Url.imageUrl('icon', 'mod_' + mod) + '\" class=\"activityicon\" />';\r\n            html = instance.htmlGenerator('mod_' + mod, img + instance.modnames[mod]);\r\n            const modlinks = $(document.createElement('div'));\r\n            modlinks.addClass('grouped_settings section_level');\r\n            modlinks.html(html);\r\n            modlinks.appendTo(instance.modlist);\r\n            instance.initlinks(modlinks, mod);\r\n        }\r\n\r\n        // Attach events.\r\n        $('#downloadcenter-all-included').click(function(e) {\r\n            instance.helper(e, true, 'item_');\r\n        });\r\n        \r\n        $('#downloadcenter-none-included').click(function(e) {\r\n            instance.helper(e, false, 'item_');\r\n        });\r\n        \r\n        $('#downloadcenter-bytype').click(function(e) {\r\n            e.preventDefault();\r\n            instance.toggletypes();\r\n        });\r\n        \r\n        // Attach event to checkboxes.\r\n        $('input.form-check-input').click(function() {\r\n            instance.checkboxhandler($(this));\r\n            instance.updateFormState();\r\n        });\r\n    };\r\n\r\n    ModFilter.prototype.checkboxhandler = function($checkbox) {\r\n        const prefix = 'item_topic';\r\n        const shortprefix = 'item_';\r\n        const name = $checkbox.prop('name');\r\n        const checked = $checkbox.prop('checked');\r\n        \r\n        if (name.substring(0, shortprefix.length) === shortprefix) {\r\n            let $parent = $checkbox.parentsUntil('form', '.card');\r\n            if ($parent.length > 1) {\r\n                $parent = $parent.first();\r\n            }\r\n            \r\n            if (name.substring(0, prefix.length) === prefix) {\r\n                $parent.find('input.form-check-input').prop('checked', checked);\r\n            } else {\r\n                if (checked) {\r\n                    $parent.find('input.form-check-input[name^=\"item_topic\"]').prop('checked', true);\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    ModFilter.prototype.updateFormState = function() {\r\n        if (this.formid && M.form && M.form.updateFormState) {\r\n            M.form.updateFormState(this.formid);\r\n        }\r\n    };\r\n\r\n    ModFilter.prototype.toggletypes = function() {\r\n        const link = $('#downloadcenter-bytype');\r\n        if (this.currentlyshown) {\r\n            link.text(this.strings.showtypes);\r\n        } else {\r\n            link.text(this.strings.hidetypes);\r\n        }\r\n        this.modlist.animate({height: 'toggle'}, 500, 'swing');\r\n        this.currentlyshown = !this.currentlyshown;\r\n    };\r\n\r\n    ModFilter.prototype.initlinks = function(links, mod) {\r\n        const instance = this;\r\n        $('#downloadcenter-all-mod_' + mod).click(function(e) {\r\n            instance.helper(e, true, 'item_', mod);\r\n        });\r\n        $('#downloadcenter-none-mod_' + mod).click(function(e) {\r\n            instance.helper(e, false, 'item_', mod);\r\n        });\r\n    };\r\n\r\n    ModFilter.prototype.helper = function(e, check, type, mod) {\r\n        e.preventDefault();\r\n        let prefix = '';\r\n        if (typeof mod !== 'undefined') {\r\n            prefix = 'item_' + mod + '_';\r\n        }\r\n\r\n        const len = type.length;\r\n\r\n        $('input[type=\"checkbox\"]').each(function() {\r\n            const checkbox = $(this);\r\n            const name = checkbox.prop('name');\r\n\r\n            if (prefix && name.substring(0, prefix.length) !== prefix) {\r\n                return;\r\n            }\r\n            if (name.substring(0, len) === type) {\r\n                checkbox.prop('checked', check);\r\n            }\r\n            if (check) {\r\n                checkbox.closest('.card.block').find('.fitem:first-child input[type=\"checkbox\"]').prop('checked', check);\r\n            }\r\n        });\r\n\r\n        this.updateFormState();\r\n    };\r\n\r\n    ModFilter.prototype.htmlGenerator = function(idtype, heading) {\r\n        let links = '<a id=\"downloadcenter-all-' + idtype + '\" href=\"#\">' + this.strings.all + '</a> / ';\r\n        links += '<a id=\"downloadcenter-none-' + idtype + '\" href=\"#\">' + this.strings.none + '</a>';\r\n        return this.rowGenerator(heading, links);\r\n    };\r\n\r\n    ModFilter.prototype.rowGenerator = function(heading, content) {\r\n        let ret = '<div class=\"form-group row fitem downloadcenter_selector\">';\r\n        ret += '<div class=\"col-md-3\"></div>';\r\n        ret += '<div class=\"col-md-9\">';\r\n        ret += '<label><span class=\"itemtitle\">' + heading + '</span></label>';\r\n        ret += '<span class=\"text-nowrap\">' + content + '</span>';\r\n        ret += '</div>';\r\n        ret += '</div>';\r\n        return ret;\r\n    };\r\n\r\n    return {\r\n        init: function(modnames) {\r\n            return new ModFilter(modnames);\r\n        }\r\n    };\r\n});"],"names":["define","$","Str","Url","ModFilter","modnames","instance","this","strings","formid","currentlyshown","modlist","get_strings","key","component","done","strs","all","none","select","showtypes","hidetypes","init","prototype","firstsection","first","length","closest","prop","showTypeOptionsLink","html","htmlGenerator","links","document","createElement","addClass","find","append","insertBefore","appendTo","hide","mod","hasOwnProperty","img","imageUrl","modlinks","initlinks","click","e","helper","preventDefault","toggletypes","checkboxhandler","updateFormState","$checkbox","name","checked","substring","$parent","parentsUntil","M","form","link","text","animate","height","check","type","prefix","len","each","checkbox","idtype","heading","rowGenerator","content","ret"],"mappings":"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"}