{"version":3,"file":"modfilter.min.js","sources":["../src/modfilter.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module filter for download center\n *\n * @module     local_downloadcenter/modfilter\n * @copyright  2025 Original: Academic Moodle Cooperation\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['core/str', 'core/url'], function(Str, Url) {\n    'use strict';\n\n    const ModFilter = function(modnames) {\n        const instance = this;\n        this.modnames = modnames;\n        this.strings = {};\n        this.formid = null;\n        this.currentlyshown = false;\n        this.modlist = null;\n\n        // Load strings.\n        Str.get_strings([\n            {key: 'all', component: 'moodle'},\n            {key: 'none', component: 'moodle'},\n            {key: 'select', component: 'moodle'},\n            {key: 'showtypes', component: 'backup'},\n            {key: 'hidetypes', component: 'backup'}\n        ]).done(function(strs) {\n            instance.strings.all = strs[0];\n            instance.strings.none = strs[1];\n            instance.strings.select = strs[2];\n            instance.strings.showtypes = strs[3];\n            instance.strings.hidetypes = strs[4];\n\n            instance.init();\n        });\n    };\n\n    ModFilter.prototype.init = function() {\n        const instance = this;\n        const firstsection = document.querySelector('div[role=\"main\"] > form .card.block');\n        \n        if (!firstsection) {\n            return;\n        }\n        \n        instance.formid = firstsection.closest('form').id;\n\n        // Add global select all/none options.\n        const showTypeOptionsLink = '<span class=\"font-weight-bold ml-3 text-nowrap\">' +\n            '(<a id=\"downloadcenter-bytype\" href=\"#\">' + instance.strings.showtypes + '</a>)</span>';\n        \n        let html = instance.htmlGenerator('included', instance.strings.select);\n        let links = document.createElement('div');\n        links.className = 'grouped_settings section_level block card';\n        links.innerHTML = html;\n        links.querySelector('.downloadcenter_selector .col-md-9').insertAdjacentHTML('beforeend', showTypeOptionsLink);\n        firstsection.parentNode.insertBefore(links, firstsection);\n\n        // For each module type, add hidden select all/none options.\n        instance.modlist = document.createElement('div');\n        instance.modlist.id = 'mod_select_links';\n        instance.modlist.className = 'm-l-2';\n        instance.modlist.style.display = 'none';\n        links.appendChild(instance.modlist);\n\n        for (let mod in instance.modnames) {\n            if (!instance.modnames.hasOwnProperty(mod)) {\n                continue;\n            }\n\n            const img = '<img src=\"' + Url.imageUrl('icon', 'mod_' + mod) + '\" class=\"activityicon\" />';\n            html = instance.htmlGenerator('mod_' + mod, img + instance.modnames[mod]);\n            const modlinks = document.createElement('div');\n            modlinks.className = 'grouped_settings section_level';\n            modlinks.innerHTML = html;\n            instance.modlist.appendChild(modlinks);\n            instance.initlinks(modlinks, mod);\n        }\n\n        // Attach events.\n        const allIncluded = document.getElementById('downloadcenter-all-included');\n        if (allIncluded) {\n            allIncluded.addEventListener('click', function(e) {\n                instance.helper(e, true, 'item_');\n            });\n        }\n        \n        const noneIncluded = document.getElementById('downloadcenter-none-included');\n        if (noneIncluded) {\n            noneIncluded.addEventListener('click', function(e) {\n                instance.helper(e, false, 'item_');\n            });\n        }\n        \n        const byType = document.getElementById('downloadcenter-bytype');\n        if (byType) {\n            byType.addEventListener('click', function(e) {\n                e.preventDefault();\n                instance.toggletypes();\n            });\n        }\n        \n        // Attach event to checkboxes.\n        document.querySelectorAll('input.form-check-input').forEach(function(checkbox) {\n            checkbox.addEventListener('click', function() {\n                instance.checkboxhandler(this);\n                instance.updateFormState();\n            });\n        });\n    };\n\n    ModFilter.prototype.checkboxhandler = function(checkbox) {\n        const prefix = 'item_topic';\n        const shortprefix = 'item_';\n        const name = checkbox.name;\n        const checked = checkbox.checked;\n        \n        if (name.substring(0, shortprefix.length) === shortprefix) {\n            let parent = checkbox.closest('.card');\n            \n            if (name.substring(0, prefix.length) === prefix) {\n                parent.querySelectorAll('input.form-check-input').forEach(function(input) {\n                    input.checked = checked;\n                });\n            } else {\n                if (checked) {\n                    const topicCheckbox = parent.querySelector('input.form-check-input[name^=\"item_topic\"]');\n                    if (topicCheckbox) {\n                        topicCheckbox.checked = true;\n                    }\n                }\n            }\n        }\n    };\n\n    ModFilter.prototype.updateFormState = function() {\n        if (this.formid && M.form && M.form.updateFormState) {\n            M.form.updateFormState(this.formid);\n        }\n    };\n\n    ModFilter.prototype.toggletypes = function() {\n        const link = document.getElementById('downloadcenter-bytype');\n        if (this.currentlyshown) {\n            link.textContent = this.strings.showtypes;\n            this.modlist.style.display = 'none';\n        } else {\n            link.textContent = this.strings.hidetypes;\n            this.modlist.style.display = 'block';\n        }\n        this.currentlyshown = !this.currentlyshown;\n    };\n\n    ModFilter.prototype.initlinks = function(links, mod) {\n        const instance = this;\n        const allModLink = document.getElementById('downloadcenter-all-mod_' + mod);\n        if (allModLink) {\n            allModLink.addEventListener('click', function(e) {\n                instance.helper(e, true, 'item_', mod);\n            });\n        }\n        \n        const noneModLink = document.getElementById('downloadcenter-none-mod_' + mod);\n        if (noneModLink) {\n            noneModLink.addEventListener('click', function(e) {\n                instance.helper(e, false, 'item_', mod);\n            });\n        }\n    };\n\n    ModFilter.prototype.helper = function(e, check, type, mod) {\n        e.preventDefault();\n        let prefix = '';\n        if (typeof mod !== 'undefined') {\n            prefix = 'item_' + mod + '_';\n        }\n\n        const len = type.length;\n\n        document.querySelectorAll('input[type=\"checkbox\"]').forEach(function(checkbox) {\n            const name = checkbox.name;\n\n            if (prefix && name.substring(0, prefix.length) !== prefix) {\n                return;\n            }\n            if (name.substring(0, len) === type) {\n                checkbox.checked = check;\n            }\n            if (check) {\n                const firstCheckbox = checkbox.closest('.card.block').querySelector('.fitem:first-child input[type=\"checkbox\"]');\n                if (firstCheckbox) {\n                    firstCheckbox.checked = check;\n                }\n            }\n        });\n\n        this.updateFormState();\n    };\n\n    ModFilter.prototype.htmlGenerator = function(idtype, heading) {\n        let links = '<a id=\"downloadcenter-all-' + idtype + '\" href=\"#\">' + this.strings.all + '</a> / ';\n        links += '<a id=\"downloadcenter-none-' + idtype + '\" href=\"#\">' + this.strings.none + '</a>';\n        return this.rowGenerator(heading, links);\n    };\n\n    ModFilter.prototype.rowGenerator = function(heading, content) {\n        let ret = '<div class=\"form-group row fitem downloadcenter_selector\">';\n        ret += '<div class=\"col-md-3\"></div>';\n        ret += '<div class=\"col-md-9\">';\n        ret += '<label><span class=\"itemtitle\">' + heading + '</span></label>';\n        ret += '<span class=\"text-nowrap\">' + content + '</span>';\n        ret += '</div>';\n        ret += '</div>';\n        return ret;\n    };\n\n    return {\n        init: function(modnames) {\n            return new ModFilter(modnames);\n        }\n    };\n});\n"],"names":["define","Str","Url","ModFilter","modnames","instance","this","strings","formid","currentlyshown","modlist","get_strings","key","component","done","strs","all","none","select","showtypes","hidetypes","init","prototype","firstsection","document","querySelector","closest","id","showTypeOptionsLink","html","htmlGenerator","links","createElement","className","innerHTML","insertAdjacentHTML","parentNode","insertBefore","style","display","appendChild","mod","hasOwnProperty","img","imageUrl","modlinks","initlinks","allIncluded","getElementById","addEventListener","e","helper","noneIncluded","byType","preventDefault","toggletypes","querySelectorAll","forEach","checkbox","checkboxhandler","updateFormState","name","checked","substring","length","parent","input","topicCheckbox","M","form","link","textContent","allModLink","noneModLink","check","type","prefix","len","firstCheckbox","idtype","heading","rowGenerator","content","ret"],"mappings":"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"}